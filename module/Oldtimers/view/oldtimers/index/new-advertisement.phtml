<div class="row">
	<nav class="navbar navbar-default">
        <div class="container-fluid">
          <div class="navbar-header">
            <a href="/" id="newAdvertisement" class="btn btn-operational navbar-btn pull-right"><?php echo $this->translate('button_cars_listing') ?></a>
<!--             <a class="navbar-brand navbar-btn" href="/"><img src="/img/logo.png" alt="vozila.me"/></a> -->
            <h4><?php echo $this->translate('form_title') ?></h4>
          </div>
        </div><!--/.container-fluid -->
      </nav>
</div>
<div class="row">
    <div id="advertisementBlock" class="col-lg-12">
        <form id="advertisementForm" action="/new" method="post" role="form" class="form" enctype="multipart/form-data">
            <div class="row">
                <div id="photos-block" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 form-group">

                    <div id="actions" class="row">
                        <div class="col-lg-12">
                            <!-- The fileinput-button span is used to style the file input field as button -->
                            <span class="btn btn-lg btn-operational fileinput-button btn-block center-block">
                            <i class="glyphicon glyphicon-plus"></i>
                            <span><?php echo $this->translate('button_add_photos') ?></span>
                        </span>
                        </div>

                        <div class="col-lg-12">
                            <!-- The global file processing state -->
                            <span class="fileupload-process">
                          <div id="total-progress" class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" style="display: none;">
                                <div class="progress-bar progress-bar-success" style="width:0%;" data-dz-uploadprogress></div>
                          </div>
                        </span>
                        </div>

                    </div>
                    <div class="help-block with-errors dz-error-message"></div>

                    <div class="table table-striped files" id="previews">
                        <div id="template" class="file-row col-lg-4 col-md-4 col-sm-6 col-xs-12">
                            <!-- This is used as the file preview template -->
                            <div>
                                <span class="preview"><img data-dz-thumbnail /><div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                        <div class="progress-bar progress-bar-success" style="width:0%;" data-dz-uploadprogress></div>
                                </div></span>
                            </div>
                            <div>
                                <!-- 							<p class="size" data-dz-size></p> -->
                            </div>
                            <div class="fileInfo">
                                <div class="name word-break" data-dz-name></div>
                                <div class="delete-block">
                                    <a data-dz-remove class="delete">
                                        <i class="glyphicon glyphicon-trash"></i>
                                    </a>
                                </div>
                            </div>
                            <div>
                                <strong class="error text-danger" data-dz-errormessage></strong>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="carDirectory" name="carDirectory" value=""/>
                    <div id="filesInputsContainer"></div>

                </div>

            </div>
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 form-group"><h3 class="text-center"><?php echo $this->translate('form_message_1') ?></h3></div>
            </div>
            <div class="row">
                <div class="col-lg-4 col-md-6 col-sm-12 col-xs-12 form-group">
                    <select id="make" name="make" class="form-control" data-error="<?php echo $this->translate('error_choose_maker') ?>" required>
                        <option value="" selected disabled><?php echo $this->translate('select_make') ?></option>
                        <?php foreach ($make as $maker): ?>
                            <option value="<?php echo $maker['make']; ?>"><?php echo $maker['make']; ?></option>
                        <?php endforeach;?>
                    </select>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-4 col-md-6 col-sm-12 col-xs-12 form-group">
                    <select id="model" name="model" class="form-control" data-error="<?php echo $this->translate('error_choose_model') ?>" required>
                        <option value="" selected disabled><?php echo $this->translate('select_model') ?></option>
                    </select>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-4 col-md-6 col-sm-12 col-xs-12 form-group">
                    <input type="text" name="modification" class="form-control" placeholder="<?php echo $this->translate('specify_modification') ?>"/>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-4 col-md-6 col-sm-6 col-xs-6 form-group">
                    <select id="transmission" name="transmission" class="form-control" data-error="<?php echo $this->translate('error_select_transmission') ?>" required>
                        <option value=""><?php echo $this->translate('select_transmission') ?></option>
                        <option value="manual"><?php echo $this->translate('manual') ?></option>
                        <option value="half_automatic"><?php echo $this->translate('half_automatic') ?></option>
                        <option value="automatic"><?php echo $this->translate('automatic') ?></option>
                    </select>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-4 col-md-6 col-sm-6 col-xs-6 form-group">
                    <select id="fuelType" name="fuelType" class="form-control" data-error="<?php echo $this->translate('error_fuel_type') ?>" required>
                        <option value=""><?php echo $this->translate('select_fuel_type') ?></option>
                        <option value="diesel"><?php echo $this->translate('diesel') ?></option>
                        <option value="petrol"><?php echo $this->translate('petrol') ?></option>
                        <option value="gas"><?php echo $this->translate('gas') ?></option>
                        <option value="petrolAndGas"><?php echo $this->translate('petrolAndGas') ?></option>
                        <option value="hybrid"><?php echo $this->translate('hybrid') ?></option>
                        <option value="electric"><?php echo $this->translate('electric') ?></option>
                    </select>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-4 col-md-6 col-sm-6 col-xs-6 form-group">
                    <input type="text" name="engineCapacity" class="form-control" data-minlength="3" placeholder="<?php echo $this->translate('engine_capacity') ?> (cm3)" data-error="<?php echo $this->translate('error_engine_capacity') ?>" required/>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-4 col-md-6 col-sm-6 col-xs-6 form-group">
                    <input type="text" name="enginePower" class="form-control" placeholder="<?php echo $this->translate('engine_power') ?> (kW)"/>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-4 col-md-6 col-sm-6 col-xs-6 form-group">
                    <input type="number" name="year" id="year" class="form-control" data-minlength="4" placeholder="<?php echo $this->translate('production_year') ?>" data-error="<?php echo $this->translate('error_production_year') ?>" required/>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-4 col-md-6 col-sm-6 col-xs-6 form-group">
                    <input type="text" name="mileage" class="form-control" placeholder="<?php echo $this->translate('mileage') ?> (km)" data-error="<?php echo $this->translate('error_mileage') ?>" required/>
                    <div class="help-block with-errors"></div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6 col-md-6 col-sm-6 form-group">
                    <label for="description" class="control-label"><?php echo $this->translate('features_title') ?></label>
                    <div class="white">
                        <div id="features-list-toggle" data-toggle="collapse" data-target="#features-list" class="collapsed">
                            <span><?php echo $this->translate('features_toggle') ?></span>
                            <span class="glyphicon glyphicon-hand-left pull-right"></span>
                        </div>
                        <ul id="features-list" class="list-group text-center collapse">
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="climatisation" name="features[climatisation]"/><?php echo $this->translate('climatisation') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="airConditioning" name="features[airConditioning]"><?php echo $this->translate('airConditioning') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="powerAssistedSteering" name="features[powerAssistedSteering]"><?php echo $this->translate('powerAssistedSteering') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="audio" name="features[audio]"><?php echo $this->translate('audio') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="towHook" name="features[towHook]"><?php echo $this->translate('towHook') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="electricWindows" name="features[electricWindows]"><?php echo $this->translate('electricWindows') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="electricHeatedSeats" name="features[electricHeatedSeats]"><?php echo $this->translate('electricHeatedSeats') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="centralLocking" name="features[centralLocking]"><?php echo $this->translate('centralLocking') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="remoteLocking" name="features[remoteLocking]"><?php echo $this->translate('remoteLocking') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="parkingSensors" name="features[parkingSensors]"><?php echo $this->translate('parkingSensors') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="fogLamp" name="features[fogLamp]"><?php echo $this->translate('fogLamp') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="immobilizer" name="features[immobilizer]"><?php echo $this->translate('immobilizer') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="navigationSystem" name="features[navigationSystem]"><?php echo $this->translate('navigationSystem') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="cruiseControl" name="features[cruiseControl]"><?php echo $this->translate('cruiseControl') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="panoramicRoof" name="features[panoramicRoof]"><?php echo $this->translate('panoramicRoof') ?></label></li>
                            <li class="list-group-item"><label class="checkbox"><input type="checkbox" value="xenonHeadlights" name="features[xenonHeadlights]"><?php echo $this->translate('xenonHeadlights') ?></label></li>
                        </ul>
                    </div>
                </div>

                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 form-group">
                    <label for="description" class="control-label"><?php echo $this->translate('car_description_title') ?></label>
                    <textarea name="description" class="form-control" rows="6"></textarea>
                    <div class="help-block with-errors"></div>
                </div>

                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 form-group"><h3 class="text-center"><?php echo $this->translate('contact_information_title') ?></h3></div>

                <div class=" col-lg-6 col-md-6 col-sm-6 col-xs-12 form-group">
                    <input type="text" name="owner[phoneNumber]" class="form-control" placeholder="<?php echo $this->translate('phone_number') ?>" data-error="<?php echo $this->translate('error_phone_number') ?>" required/>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 form-group">
                    <select id="city" name="owner[city]" class="form-control" data-error="<?php echo $this->translate('error_location') ?>" required>
                        <option value=""><?php echo $this->translate('select_location') ?></option>
                        <?php foreach($cities as $city): ?>
                            <option value="<?= $city['name']?>"><?= $city['name']?></option>
                        <?php endforeach; ?>
                    </select>
                    <div class="help-block with-errors"></div>
                </div>

                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 form-group">
                    <div class="input-group">
                        <span class="input-group-addon">€</span>
                        <input type="text" name="price" id="price" class="form-control" placeholder="<?php echo $this->translate('price') ?>" data-error="<?php echo $this->translate('error_price') ?>" required/>
                    </div>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 form-group">
                    <div class="input-group">
                        <span class="input-group-addon">@</span>
                        <input type="email" name="owner[email]" class="form-control" placeholder="<?php echo $this->translate('user_email') ?>" data-error="<?php echo $this->translate('user_email_error') ?>" />
                    </div>
                    <span class="help-inline"><?php echo $this->translate('email_notification_label') ?></span>
                    <div class="help-block with-errors"></div>
                </div>


            </div>
            <div class="row">
                <div id="post-block" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 form-group">
                    <button type="submit" id="post" class="btn btn-operational btn-block center-block"><?php echo $this->translate('button_submit') ?></button>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
var carDirectory = '<?= $carDirectory ?>';

$(document).ready(function(){
    $('#carDirectory').val(carDirectory);

    // Get the template HTML and remove it from the doument
    var previewNode = document.querySelector("#template");
    previewNode.id = "";
    var previewTemplate = previewNode.parentNode.innerHTML;
    previewNode.parentNode.removeChild(previewNode);

    var myDropzone = new Dropzone(document.body, { // Make the whole body a dropzone
      url: "/index/saveFile", // Set the url
      params: {
          carDirectory : $('#carDirectory').val()
          },
      maxFilesize: 4,
      maxFiles: 15,
      thumbnailWidth: 350,
      thumbnailHeight: 220,
      parallelUploads: 15,
      previewTemplate: previewTemplate,
      acceptedFiles: 'image/jpeg, image/png, image/gif',
      autoQueue: true, // Make sure the files aren't queued until manually added
      previewsContainer: "#previews", // Define the container to display the previews
      clickable: ".fileinput-button", // Define the element that should be used as click trigger to select files.
      success: function(file, response){
          if(response){
          	if(response.fileId && response.carDirectory) {
	            $('#carDirectory').val(response.carDirectory);
	            $('#filesInputsContainer').append($('<input>').attr('type', 'hidden').attr('name', 'photos[]').attr('value', response.fileId));
            }else{
	            $.each(response, function(key, value) {
		            $(file.previewElement).find('.error').append(value + '<br/>');
	            });

            }
          }
      }
    });

    myDropzone.on("addedfile", function(file) {
      $('#post').attr('disabled', true);
      // Hookup the start button
      //file.previewElement.querySelector(".start").onclick = function() { myDropzone.enqueueFile(file); };
    });

    // Update the total progress bar
    myDropzone.on("totaluploadprogress", function(progress) {
    	document.querySelector("#total-progress .progress-bar").style.width = progress + "%";
    });

    myDropzone.on("sending", function(file) {
      // Show the total progress bar when upload starts
      document.querySelector("#total-progress").style.display = "block";
      // And disable the start button
	    $('#post').attr('disabled', true);
    });

    // Hide the total progress bar when nothing's uploading anymore
    myDropzone.on("queuecomplete", function(progress) {
        $('#post').attr('disabled', false);
    	document.querySelector("#total-progress").style.display = "none";
    });

    // Setup the buttons for all transfers
    // The "add files" button doesn't need to be setup because the config
    // `clickable` has already been specified.
//     document.querySelector("#actions .start").onclick = function() {
//       myDropzone.enqueueFiles(myDropzone.getFilesWithStatus(Dropzone.ADDED));
//     };
//     document.querySelector("#actions .cancel").onclick = function() {
//       myDropzone.removeAllFiles(true);
//     };

	$('#make').change(function(){
		$.ajax({
		  url: "index/getModelByMakeIdJson",
		  data: {'make' : $(this).val()}
		}).done(function(responce) {
			if(responce.success){
				var model = $("#model").empty();
				$.each(responce.models, function() {
					model.append($("<option />").val(this.model).text(this.model));
				});
			}
		});
	});

	$('#advertisementForm').find('button[type=submit]').on('click', function(e) {
		if(!myDropzone.files.length) {
			$('html, body').animate({
				scrollTop: $(".fileinput-button").offset().top - 100
			}, 100);

			$('.fileinput-button').addClass('animate-button');

			$('.fileinput-button').one('webkitAnimationEnd oanimationend msAnimationEnd animationend',

            function (e) {
                $('.fileinput-button').removeClass('animate-button');
            });
		} else if(myDropzone.getRejectedFiles().length > 0 || myDropzone.getQueuedFiles().length){
			var rejected_files = myDropzone.getRejectedFiles();
			$('html, body').animate({
				scrollTop: $(rejected_files[0]['previewTemplate']).offset().top - 100
			}, 100);
			return false;
        }else{
			if (!$('#advertisementForm').validator('validate').has('.has-error').length) {
				$('#advertisementForm').submit();
			}
        }

        e.preventDefault();
		return false;
    });

	$('#features-list').on('change', 'input', function(e){
		if($(this).is(':checked')){
			$(this).parent().parent().addClass('aliceblue');
			$(this).parent().parent().removeClass('white');
        }else{
			$(this).parent().parent().addClass('white');
			$(this).parent().parent().removeClass('aliceblue');
        }
    });

	$('#features-list').on('show.bs.collapse', function(){
        $(this).parent().find('.glyphicon').removeClass('glyphicon-hand-left').addClass('glyphicon-hand-down');
    });

	$('#features-list').on('hide.bs.collapse', function(){
		$(this).parent().find('.glyphicon').removeClass('glyphicon-hand-down').addClass('glyphicon-hand-left');
	});

	$('#year').yearselect({
		start: 1950,
		end: 2017,
		order: 'desc'
	});

	$(window).bind('resize load', function() {
		if ($(this).width() < 767) {
			$('#features-list').addClass('collapse');
			$('#features-list-toggle').show();
		} else {
			$('#features-list-toggle').hide();
			$('#features-list').removeClass('collapse');
		}
	});

});
</script>

<?php
	$this->headScript()->prependFile($this->basePath('js/validator.js'));
?>
