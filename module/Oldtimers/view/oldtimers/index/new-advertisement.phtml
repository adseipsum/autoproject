<div class="row">
	<nav class="navbar navbar-default">
        <div class="container-fluid">
          <div class="navbar-header">
            <a href="/" class="btn btn-operational navbar-btn pull-right"><?php echo $this->translate('button_cars_listing') ?></a>
            <!--             <a class="navbar-brand navbar-btn" href="/"><img src="/img/logo.png" alt="vozila.me"/></a> -->
            <a class="navbar-brand" href="/"><img src="/img/logo.png" style="height: 30px;" alt="makina.plus"/></a>

            <div class="language-group">
              <select id="switchLanguage" class="pull-left">
                  <option value="sr_SP">CG</option>
                  <option value="en_US">EN</option>
                  <option value="ru_RU">RU</option>
              </select>
            </div>
          </div>
        </div><!--/.container-fluid -->
      </nav>
</div>
<div class="row">
    <form id="advertisementForm" action="/new" method="post" role="form" class="form" enctype="multipart/form-data">
        <div id="advertisementBlock" class="col-lg-10 col-md-12 col-sm-12 col-xs-12 col-lg-offset-1">
            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 form-group"><h3 class="text-center"><?php echo $this->translate('form_message_1') ?></h3></div>
            </div>
            <div class="row">
                <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group">
                    <select id="make" name="make" class="form-control input-lg" data-error="<?php echo $this->translate('error_choose_maker') ?>" required>
                        <option value="" selected disabled><?php echo $this->translate('select_make') ?></option>
                        <?php foreach ($make as $maker): ?>
                            <option value="<?php echo $maker['make']; ?>" data-thumbnail="img/circle.png"><?php echo $maker['make']; ?></option>
                        <?php endforeach;?>
                    </select>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group">
                    <select id="model" name="model" class="form-control input-lg" data-error="<?php echo $this->translate('error_choose_model') ?>" required>
                        <option value="" selected disabled><?php echo $this->translate('select_model') ?></option>
                    </select>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 form-group">
                    <input type="text" name="modification" class="form-control input-lg" placeholder="<?php echo $this->translate('specify_modification') ?>"/>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 form-group">
                    <input type="number" name="year" id="year" class="form-control input-lg" data-minlength="4" placeholder="<?php echo $this->translate('production_year') ?>" data-error="<?php echo $this->translate('error_production_year') ?>" required/>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group text-center">
                    <h3><?php echo $this->translate('select_transmission') ?></h3>
                    <ul id="transmissionRadioBlock" class="form-group" data-error="<?php echo $this->translate('error_select_transmission') ?>">
                        <label>
                            <input type="radio" name="transmission" value="manual">
                            <span><?php echo $this->translate('manual') ?></span>
                        </label>
                        <label>
                            <input type="radio" name="transmission" value="half_automatic">
                            <span><?php echo $this->translate('half_automatic') ?></span>
                        </label>
                        <label>
                            <input type="radio" name="transmission" value="automatic">
                            <span><?php echo $this->translate('automatic') ?></span>
                        </label>
                    </ul>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group text-center">
                    <h3><?php echo $this->translate('select_fuel_type') ?></h3>
                    <ul id="fuelTypeRadioBlock" class="form-group" data-error="<?php echo $this->translate('error_select_transmission') ?>">
                        <label>
                            <input type="radio" name="fuelType" value="diesel">
                            <span><?php echo $this->translate('diesel') ?></span>
                        </label>
                        <label>
                            <input type="radio" name="fuelType" value="petrolAndGas">
                            <span><?php echo $this->translate('petrolAndGas') ?></span>
                        </label>
                        <label>
                            <input type="radio" name="fuelType" value="petrol">
                            <span><?php echo $this->translate('petrol') ?></span>
                        </label>
                        <label>
                            <input type="radio" name="fuelType" value="hybrid">
                            <span><?php echo $this->translate('hybrid') ?></span>
                        </label>
                        <label>
                            <input type="radio" name="fuelType" value="electric">
                            <span><?php echo $this->translate('electric') ?></span>
                        </label>
                    </ul>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group text-center">
                    <h3><?php echo $this->translate('engine_capacity') ?></h3>
                    <div class="input-group col-lg-4 col-md-6 col-sm-6 col-xs-8 col-lg-offset-4 col-md-offset-3 col-sm-offset-3 col-xs-offset-2">
                        <input name="engineCapacity" id="engineCapacityValue" class="form-control input-lg" data-error="<?php echo $this->translate('error_engine_capacity') ?>" value="2000"/>
                        <span class="input-group-addon">cm3</span>
                    </div>
                    <div class="input-group col-lg-12 col-md-12 col-sm-12 col-xs-12">
                      <input id="engineCapacity" class="form-control" type="text" data-slider-min="100" data-slider-max="6000" data-slider-step="100" data-slider-value="2000"/>
                    </div>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12 form-group text-center">
                    <h3><?php echo $this->translate('mileage') ?></h3>
                    <div class="input-group col-lg-4 col-md-6 col-sm-6 col-xs-8 col-lg-offset-4 col-md-offset-3 col-sm-offset-3 col-xs-offset-2">
                        <input name="mileage" id="mileageValue" class="form-control input-lg" data-error="<?php echo $this->translate('error_mileage') ?>" value="50000"/>
                        <span class="input-group-addon">km</span>
                    </div>
                    <div class="input-group col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <input id="mileage" class="form-control" data-slider-id='mileageSlider' type="text" data-slider-min="0" data-slider-max="600000" data-slider-step="5000" data-slider-value="50000"/>
                    </div>
                    <div class="help-block with-errors"></div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6 col-md-6 col-sm-6 form-group text-center">
                    <h3><?php echo $this->translate('features_title') ?></h3>
                    <div id="features-list">
                        <label><input type="checkbox" value="fourWeelDrive" name="features[fourWeelDrive]"><span><?php echo $this->translate('fourWeelDrive') ?></span></label>
                        <label><input type="checkbox" value="climatisation" name="features[climatisation]"/><span><?php echo $this->translate('climatisation') ?></span></label>
                        <label><input type="checkbox" value="airConditioning" name="features[airConditioning]"><span><?php echo $this->translate('airConditioning') ?></span></label>
                        <label><input type="checkbox" value="powerAssistedSteering" name="features[powerAssistedSteering]"><span><?php echo $this->translate('powerAssistedSteering') ?></span></label>
                        <label><input type="checkbox" value="audio" name="features[audio]"><span><?php echo $this->translate('audio') ?></span></label>
                        <label><input type="checkbox" value="towHook" name="features[towHook]"><span><?php echo $this->translate('towHook') ?></span></label>
                        <label><input type="checkbox" value="electricWindows" name="features[electricWindows]"><span><?php echo $this->translate('electricWindows') ?></span></label>
                        <label><input type="checkbox" value="electricHeatedSeats" name="features[electricHeatedSeats]"><span><?php echo $this->translate('electricHeatedSeats') ?></span></label>
                        <label><input type="checkbox" value="xenonHeadlights" name="features[xenonHeadlights]"><span><?php echo $this->translate('xenonHeadlights') ?></span></label>
                        <label><input type="checkbox" value="centralLocking" name="features[centralLocking]"><span><?php echo $this->translate('centralLocking') ?></span></label>
                        <label><input type="checkbox" value="remoteLocking" name="features[remoteLocking]"><span><?php echo $this->translate('remoteLocking') ?></span></label>
                        <label><input type="checkbox" value="parkingSensors" name="features[parkingSensors]"><span><?php echo $this->translate('parkingSensors') ?></span></label>
                        <label><input type="checkbox" value="fogLamp" name="features[fogLamp]"><span><?php echo $this->translate('fogLamp') ?></span></label>
                        <label><input type="checkbox" value="immobilizer" name="features[immobilizer]"><span><?php echo $this->translate('immobilizer') ?></span></label>
                        <label><input type="checkbox" value="navigationSystem" name="features[navigationSystem]"><span><?php echo $this->translate('navigationSystem') ?></span></label>
                        <label><input type="checkbox" value="cruiseControl" name="features[cruiseControl]"><span><?php echo $this->translate('cruiseControl') ?></span></label>
                        <label><input type="checkbox" value="panoramicRoof" name="features[panoramicRoof]"><span><?php echo $this->translate('panoramicRoof') ?></span></label>
                    </div>
                </div>

                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 form-group text-center">
                    <label for="description" class="control-label"><?php echo $this->translate('car_description_title') ?></label>
                    <textarea id="description" name="description" class="form-control input-lg" rows="7"></textarea>
                    <div class="help-block with-errors"></div>
                </div>

                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 form-group"><h3 class="text-center"><?php echo $this->translate('contact_information_title') ?></h3></div>

                <div class=" col-lg-6 col-md-6 col-sm-6 col-xs-12 form-group">
                    <input type="text" name="owner[phoneNumber]" class="form-control input-lg" placeholder="<?php echo $this->translate('phone_number') ?>" data-error="<?php echo $this->translate('error_phone_number') ?>" required/>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 form-group">
                    <select id="city" name="owner[city]" class="form-control input-lg" data-error="<?php echo $this->translate('error_location') ?>" required>
                        <option value=""><?php echo $this->translate('select_location') ?></option>
                        <?php foreach($cities as $city): ?>
                            <option value="<?= $city['name']?>"><?= $city['name']?></option>
                        <?php endforeach; ?>
                    </select>
                    <div class="help-block with-errors"></div>
                </div>

                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 form-group">
                    <div class="input-group">
                        <span class="input-group-addon">€</span>
                        <input type="text" name="price" id="price" class="form-control input-lg" placeholder="<?php echo $this->translate('price') ?>" data-error="<?php echo $this->translate('error_price') ?>" required/>
                    </div>
                    <div class="help-block with-errors"></div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12 form-group">
                    <div class="input-group">
                        <span class="input-group-addon">@</span>
                        <input type="email" name="owner[email]" class="form-control input-lg" placeholder="<?php echo $this->translate('user_email') ?>" data-error="<?php echo $this->translate('user_email_error') ?>" />
                    </div>
                    <span class="help-inline"><?php echo $this->translate('email_notification_label') ?></span>
                    <div class="help-block with-errors"></div>
                </div>


            </div>
            <div class="row">
                <div id="photos-block" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 form-group">

                    <div id="actions" class="row">
                        <div class="col-lg-12">
                            <!-- The fileinput-button span is used to style the file input field as button -->
                            <span id="add_photo" class="btn btn-lg btn-operational fileinput-button btn-block center-block">
                            <i class="glyphicon glyphicon-picture"></i>
                            <span><?php echo $this->translate('button_add_photos') ?></span>
                        </span>
                        </div>

                        <div class="col-lg-12">
                            <!-- The global file processing state -->
                            <span class="fileupload-process">
                          <div id="total-progress" class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" style="display: none;">
                                <div class="progress-bar progress-bar-success" style="width:0%;" data-dz-uploadprogress></div>
                          </div>
                        </span>
                        </div>

                    </div>
                    <div class="help-block with-errors dz-error-message"></div>

                    <div class="table table-striped files" id="previews">
                        <div id="template" class="file-row col-lg-4 col-md-4 col-sm-6 col-xs-12">
                            <!-- This is used as the file preview template -->
                            <div>
                                <span class="preview"><img data-dz-thumbnail /><div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                        <div class="progress-bar progress-bar-success" style="width:0%;" data-dz-uploadprogress></div>
                                </div></span>
                            </div>
                            <div>
                                <!-- 							<p class="size" data-dz-size></p> -->
                            </div>
                            <div class="fileInfo">
                                <div class="name word-break" data-dz-name></div>
                                <div class="delete-block">
                                    <a data-dz-remove class="delete">
                                        <i class="glyphicon glyphicon-trash"></i>
                                    </a>
                                </div>
                            </div>
                            <div>
                                <strong class="error text-danger" data-dz-errormessage></strong>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="carDirectory" name="carDirectory" value=""/>
                    <div id="filesInputsContainer"></div>

                </div>

            </div>
            <div class="row">
                <div id="post-block" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 form-group">
                    <button type="submit" id="post" class="btn btn-lg btn-operational btn-block center-block">
                        <?php echo $this->translate('button_submit') ?>
                        <span class="glyphicon glyphicon-plus"></span>
                    </button>
                    <div class="help-block with-errors"></div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
var carDirectory = '<?= $carDirectory ?>';

$(document).ready(function(){
    $('#carDirectory').val(carDirectory);

    // Get the template HTML and remove it from the doument
    var previewNode = document.querySelector("#template");
    previewNode.id = "";
    var previewTemplate = previewNode.parentNode.innerHTML;
    previewNode.parentNode.removeChild(previewNode);

    $('#transmissionRadioBlock input').iCheck({
        radioClass: 'iradio_flat'
    });

    $('#fuelTypeRadioBlock input').iCheck({
        radioClass: 'iradio_flat'
    });

    $('#features-list input').iCheck({
        checkboxClass: 'icheckbox_flat'
    });

    $('#engineCapacity, #mileage').slider();

    $("#engineCapacity").on("slide", function(slideEvt) {
        $("#engineCapacityValue").val(slideEvt.value);
    });

    $("#mileage").on("slide", function(slideEvt) {
        $("#mileageValue").val(slideEvt.value);
    });

    ////$('select').selectpicker({caretIcon: 'glyphicon glyphicon-menu-down'});

    var $switcher = $('#switchLanguage');

    $switcher.val('<?= $language ?>');
    $("#switchLanguage option[value='<?= $language ?>']").hide();

    $switcher.selectpicker();

    $switcher.on('change', function($e) {
        $e.preventDefault();

        $.ajax({
            type: 'POST',
            url: '/index/language',
            data: {'language': $(this).val()},
        }).done(function(responce) {
            if (responce.success) {
                setTimeout(function() {
                    window.location.reload();
                }, 50);
            }
        });
    });

    var myDropzone = new Dropzone(document.body, { // Make the whole body a dropzone
      url: "/index/saveFile", // Set the url
      params: {
          carDirectory : $('#carDirectory').val()
          },
      maxFilesize: 8,
      maxFiles: 15,
      thumbnailWidth: 350,
      thumbnailHeight: 220,
      parallelUploads: 5,
      previewTemplate: previewTemplate,
      acceptedFiles: 'image/jpeg, image/png, image/gif',
      autoQueue: true, // Make sure the files aren't queued until manually added
      previewsContainer: "#previews", // Define the container to display the previews
      clickable: ".fileinput-button", // Define the element that should be used as click trigger to select files.
      success: function(file, response){
          if(response){
          	if(response.fileId && response.carDirectory) {
	            $('#carDirectory').val(response.carDirectory);
	            $('#filesInputsContainer').append($('<input>').attr('type', 'hidden').attr('name', 'photos[]').attr('value', response.fileId));
            }else{
	            $.each(response, function(key, value) {
		            $(file.previewElement).find('.error').append(value + '<br/>');
	            });

            }
          }
      }
    });

    myDropzone.on("addedfile", function(file) {
      $('#post').attr('disabled', true);
      // Hookup the start button
      //file.previewElement.querySelector(".start").onclick = function() { myDropzone.enqueueFile(file); };
    });

    // Update the total progress bar
    myDropzone.on("totaluploadprogress", function(progress) {
    	document.querySelector("#total-progress .progress-bar").style.width = progress + "%";
    });

    myDropzone.on("sending", function(file) {
      // Show the total progress bar when upload starts
      document.querySelector("#total-progress").style.display = "block";
      // And disable the start button
	    $('#post').attr('disabled', true);
    });

    // Hide the total progress bar when nothing's uploading anymore
    myDropzone.on("queuecomplete", function(progress) {
        $('#post').attr('disabled', false);
    	document.querySelector("#total-progress").style.display = "none";
    });

    // Setup the buttons for all transfers
    // The "add files" button doesn't need to be setup because the config
    // `clickable` has already been specified.
//     document.querySelector("#actions .start").onclick = function() {
//       myDropzone.enqueueFiles(myDropzone.getFilesWithStatus(Dropzone.ADDED));
//     };
//     document.querySelector("#actions .cancel").onclick = function() {
//       myDropzone.removeAllFiles(true);
//     };

	$('#make').change(function(){
		$.ajax({
		  url: "index/getModelByMakeIdJson",
		  data: {'make' : $(this).val()}
		}).done(function(responce) {
			if(responce.success){
				var model = $("#model").empty();
				$.each(responce.models, function() {
					model.append($("<option />").val(this.model).text(this.model));
				});
			}
		});
	});

	$('#advertisementForm').find('button[type=submit]').on('click', function(e) {
		if(!myDropzone.files.length) {
			$('html, body').animate({
				scrollTop: $(".fileinput-button").offset().top - 100
			}, 100);

			$('.fileinput-button').addClass('animate-button');

			$('.fileinput-button').one('webkitAnimationEnd oanimationend msAnimationEnd animationend',

            function (e) {
                $('.fileinput-button').removeClass('animate-button');
            });
		} else if(myDropzone.getRejectedFiles().length > 0 || myDropzone.getQueuedFiles().length){
			var rejected_files = myDropzone.getRejectedFiles();
			$('html, body').animate({
				scrollTop: $(rejected_files[0]['previewTemplate']).offset().top - 100
			}, 100);
			return false;
        }else{
			if (!$('#advertisementForm').validator('validate').has('.has-error').length) {
				$('#advertisementForm').submit();
			}
        }

        e.preventDefault();
		return false;
    });

	$('#features-list').on('change', 'input', function(e){
		if($(this).is(':checked')){
			$(this).parent().parent().addClass('aliceblue');
			$(this).parent().parent().removeClass('white');
        }else{
			$(this).parent().parent().addClass('white');
			$(this).parent().parent().removeClass('aliceblue');
        }
    });

	$('#features-list').on('show.bs.collapse', function(){
        $(this).parent().find('.glyphicon').removeClass('glyphicon-hand-left').addClass('glyphicon-hand-down');
    });

	$('#features-list').on('hide.bs.collapse', function(){
		$(this).parent().find('.glyphicon').removeClass('glyphicon-hand-down').addClass('glyphicon-hand-left');
	});

	$('#year').yearselect({
		start: 1950,
		end: 2017,
		order: 'desc'
	});

	// $(window).bind('resize load', function() {
	// 	if ($(this).width() < 767) {
	// 		$('#features-list').addClass('collapse');
	// 		$('#features-list-toggle').show();
	// 	} else {
	// 		$('#features-list-toggle').hide();
	// 		$('#features-list').removeClass('collapse');
	// 	}
	// });

});
</script>

<?php
	$this->headScript()->prependFile($this->basePath('js/validator.js'));
?>

<!--temp place for popup-->
<script>
	$.ajax({
		url: "index/carInfoJson?id=" + $(this).attr('id'),
	}).done(function(responce) {
		if(responce.carInfo){
			var info = responce.carInfo;
			$('#carModal').find('.modal-title').html(info.make + ' ' + info.model);
			$('#carModal').find('.carousel-inner').html('');
			$('#generalInfo').html('');
			$('#features').html('');
			$('#description').html('');
			$('#ownerInfo').html('');

			$.each(info.photos, function( key, value ) {

				var div = $('#carModal').find('.carousel-inner').append(
					$('<div>').addClass('item').html(
						$('<img>')
							.attr('src', 'uploads/' +  value + '.jpg'))
						.append($('<span>').addClass('price').html(info.price + '€')));
				if(key == 0){
					$(div).find(':first').addClass('active');
				}
			});

			$('#carModal').find('.carousel-control.right, .carousel-control.left').css('opacity', 0.5);

			$('#generalInfo').append($('<table>').addClass('infoTable table')
				.append('<tr><td width="120"><span>Proizvođač:</span></td><td>' + info.make + '</td></tr>')
				.append('<tr><td><span><?php echo $this->translate('select_make') ?>:</span></td><td>' + info.model + '</td></tr>')
				.append('<tr><td><span><?php echo $this->translate('production_year') ?>:</span></td><td>' + info.year + '</td></tr>')
				.append('<tr><td><span><?php echo $this->translate('select_transmission') ?>:</span></td><td>' + info.transmission + '</td></tr>')
				.append('<tr><td><span><?php echo $this->translate('select_fuel_type') ?>:</span></td><td>' + info.fuelType + '</td></tr>')
				.append('<tr><td><span><?php echo $this->translate('engine_capacity') ?>:</span></td><td>' + info.engineCapacity + ' cm<sup>3</sup></td></tr>')
				.append('<tr><td><span><?php echo $this->translate('engine_power') ?>:</span></td><td>' + info.enginePower + ' kW</tr>')
				.append('<tr><td><span><?php echo $this->translate('mileage') ?>:</span></td><td>' + info.mileage + ' km</td></tr>'));

			$('#features').append(
				$('<div>')
					.addClass('panel list-group')
					.append(
						$('<a>')
							.attr('href', '#')
							.attr('data-toggle', 'collapse')
							.attr('data-target', '#sm')
							.attr('data-parent', '#menu')
							.addClass('list-group-item')
							.append($('<span>').html('<?php echo $this->translate('features_toggle') ?>'))
							.append($('<span>').addClass('glyphicon glyphicon-hand-down pull-right'))
					)
					.append(
						$('<div>').attr('id', 'sm').addClass('sublinks collapse')
					)
			);
			$.each(info.features, function( key, value ) {
				$('#features .sublinks').append($('<a>').addClass('list-group-item small').html(value));
			});

			$('#description').append($('<table>').attr('id', 'description').addClass('table').append('<tr><td colspan="2">' + info.description + '</td></tr>'));

			var t = info.date.date.split(/[- :]/);
			var date = new Date(t[0], t[1]-1, t[2], t[3], t[4], t[5]);

			$('#ownerInfo').append(
				$('<table>').attr('id', 'ownerInfoTable').addClass('table')
					.append('<tr><td width="120"><span><?php echo $this->translate('select_location') ?>:</span></td><td>' + info.owner['city'] + '</td></tr>')
					.append('<tr><td><span><?php echo $this->translate('phone_number') ?>:</span></td><td><a href="tel:' + info.owner['phoneNumber'] + '">' + info.owner['phoneNumber'] + '</a> <small><i>(click to call)</i></small></td></tr>')
					.append('<tr><td><span><?php echo $this->translate('date') ?>:</span></td><td>' + date.toLocaleDateString() + '</td></tr>')
			);

			$('#delete').html(info._id);


		}
	});
</script>
